{% extends "base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root {
    --nano-primary: #7c3aed;
    --nano-secondary: #ec4899;
    --nano-accent: #06b6d4;
    --nano-success: #10b981;
    --nano-warning: #f59e0b;
}

.nano-gradient {
    background: linear-gradient(135deg, var(--nano-primary) 0%, var(--nano-secondary) 50%, var(--nano-accent) 100%);
}

.nano-text-gradient {
    background: linear-gradient(135deg, var(--nano-primary), var(--nano-secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.mode-card {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.mode-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.mode-card.active {
    border-color: var(--nano-primary);
    background: rgba(124, 58, 237, 0.1);
}

.mode-card .mode-icon {
    font-size: 2rem;
    transition: all 0.3s ease;
}

.mode-card:hover .mode-icon {
    transform: scale(1.2);
}

.upload-zone {
    border: 3px dashed rgba(124, 58, 237, 0.3);
    border-radius: 1rem;
    transition: all 0.3s ease;
    background: rgba(124, 58, 237, 0.02);
    min-height: 400px;
}

.upload-zone:hover {
    border-color: var(--nano-primary);
    background: rgba(124, 58, 237, 0.05);
}

.upload-zone.dragover {
    border-color: var(--nano-secondary);
    background: rgba(236, 72, 153, 0.1);
    transform: scale(1.02);
}

.image-preview-container {
    position: relative;
    border-radius: 1rem;
    overflow: hidden;
    background: #000;
}

.image-preview {
    width: 100%;
    height: auto;
    max-height: 500px;
    object-fit: contain;
}

.history-item {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
}

.history-item:hover {
    transform: scale(1.05);
    z-index: 10;
}

.history-timeline {
    position: relative;
    padding: 1rem 0;
}

.history-timeline::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--nano-primary);
}

.timeline-item {
    position: relative;
    padding-left: 50px;
    margin-bottom: 2rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 10px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--nano-secondary);
    border: 4px solid #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-overlay.active {
    display: flex;
}

.loading-content {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    max-width: 400px;
    text-align: center;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    margin: 1rem 0;
}

.progress-fill {
    height: 100%;
    background: var(--nano-gradient);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.result-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 1rem;
}

.result-item {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    background: #000;
}

.result-item img {
    width: 100%;
    height: auto;
    display: block;
}

.result-actions {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    padding: 1rem;
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.result-item:hover .result-actions {
    opacity: 1;
}

.style-option {
    padding: 0.5rem 1rem;
    border: 2px solid transparent;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.style-option:hover {
    border-color: var(--nano-primary);
}

.style-option.selected {
    background: var(--nano-primary);
    color: white;
}

.advanced-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.control-slider {
    width: 100%;
}


@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes slideIn {
    from {
        transform: translateX(-100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.slide-in {
    animation: slideIn 0.5s ease-out;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold nano-text-gradient mb-3">Magix Nano Studio</h1>
            <p class="text-xl text-base-content/70">Powered by Google's Nano Banana Pro (Nano Banana 2)</p>
            <p class="text-sm text-base-content/50 mt-2">State-of-the-art image generation and editing with 1K/2K/4K support</p>
        </div>

        <!-- Mode Selection -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Select Portrait Style</h2>

            <!-- Main Popular Modes - 4x2 Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-3 mb-4">
                <div class="mode-card card bg-gradient-to-br from-purple-500/20 to-indigo-500/20 p-4 border border-purple-500/30" data-mode="studio_portrait">
                    <div class="text-center">
                        <i class="fas fa-camera mode-icon text-purple-500"></i>
                        <h3 class="font-bold mt-2 text-sm">Studio</h3>
                        <p class="text-xs text-base-content/60">Clean & Polished</p>
                    </div>
                </div>

                <div class="mode-card card bg-gradient-to-br from-amber-500/20 to-orange-500/20 p-4 border border-amber-500/30" data-mode="cinematic">
                    <div class="text-center">
                        <i class="fas fa-film mode-icon text-amber-500"></i>
                        <h3 class="font-bold mt-2 text-sm">Cinematic</h3>
                        <p class="text-xs text-base-content/60">Movie Scene</p>
                    </div>
                </div>

                <div class="mode-card card bg-gradient-to-br from-blue-500/20 to-cyan-500/20 p-4 border border-blue-500/30" data-mode="corporate_headshot">
                    <div class="text-center">
                        <i class="fas fa-user-tie mode-icon text-blue-500"></i>
                        <h3 class="font-bold mt-2 text-sm">Corporate</h3>
                        <p class="text-xs text-base-content/60">LinkedIn Ready</p>
                    </div>
                </div>

                <div class="mode-card card bg-gradient-to-br from-pink-500/20 to-rose-500/20 p-4 border border-pink-500/30" data-mode="fashion_editorial">
                    <div class="text-center">
                        <i class="fas fa-gem mode-icon text-pink-500"></i>
                        <h3 class="font-bold mt-2 text-sm">Fashion</h3>
                        <p class="text-xs text-base-content/60">Editorial Style</p>
                    </div>
                </div>

                <div class="mode-card card bg-gradient-to-br from-rose-500/20 to-red-500/20 p-4 border border-rose-500/30" data-mode="dating">
                    <div class="text-center">
                        <i class="fas fa-heart mode-icon text-rose-500"></i>
                        <h3 class="font-bold mt-2 text-sm">Dating</h3>
                        <p class="text-xs text-base-content/60">Tinder & Apps</p>
                    </div>
                </div>

                <div class="mode-card card bg-gradient-to-br from-emerald-500/20 to-teal-500/20 p-4 border border-emerald-500/30" data-mode="founder_headshot">
                    <div class="text-center">
                        <i class="fas fa-rocket mode-icon text-emerald-500"></i>
                        <h3 class="font-bold mt-2 text-sm">Founder</h3>
                        <p class="text-xs text-base-content/60">Startup Leader</p>
                    </div>
                </div>

                <div class="mode-card card bg-gradient-to-br from-fuchsia-500/20 to-pink-500/20 p-4 border border-fuchsia-500/30" data-mode="influencer">
                    <div class="text-center">
                        <i class="fab fa-instagram mode-icon text-fuchsia-500"></i>
                        <h3 class="font-bold mt-2 text-sm">Influencer</h3>
                        <p class="text-xs text-base-content/60">Social Media</p>
                    </div>
                </div>

                <div class="mode-card card bg-gradient-to-br from-slate-500/20 to-gray-500/20 p-4 border border-slate-500/30" data-mode="street_portrait">
                    <div class="text-center">
                        <i class="fas fa-city mode-icon text-slate-500"></i>
                        <h3 class="font-bold mt-2 text-sm">Street</h3>
                        <p class="text-xs text-base-content/60">Urban Style</p>
                    </div>
                </div>
            </div>

            <!-- Selected Mode Description -->
            <div id="modeDescription" class="alert bg-base-200 mb-4">
                <div>
                    <i id="modeDescIcon" class="fas fa-camera text-2xl text-purple-500"></i>
                    <div>
                        <h3 id="modeDescTitle" class="font-bold">Studio Portrait</h3>
                        <p id="modeDescText" class="text-sm text-base-content/70">Professional studio photography with clean background, soft diffused lighting, and polished refined look. Perfect for portfolios and professional use.</p>
                    </div>
                </div>
            </div>

            <!-- More Styles - Collapsible -->
            <div class="collapse collapse-arrow bg-base-200 rounded-xl">
                <input type="checkbox" id="moreStylesToggle" />
                <div class="collapse-title font-medium flex items-center gap-2">
                    <i class="fas fa-th-large text-base-content/60"></i>
                    More Portrait Styles
                    <span class="badge badge-sm badge-primary">+14 styles</span>
                </div>
                <div class="collapse-content">
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 pt-2">
                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="environmental">
                            <div class="text-center">
                                <i class="fas fa-tree mode-icon text-green-500"></i>
                                <h3 class="font-bold mt-2 text-xs">Environmental</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="lifestyle">
                            <div class="text-center">
                                <i class="fas fa-coffee mode-icon text-amber-600"></i>
                                <h3 class="font-bold mt-2 text-xs">Lifestyle</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="low_key">
                            <div class="text-center">
                                <i class="fas fa-moon mode-icon text-gray-700"></i>
                                <h3 class="font-bold mt-2 text-xs">Low-Key</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="high_key">
                            <div class="text-center">
                                <i class="fas fa-sun mode-icon text-yellow-400"></i>
                                <h3 class="font-bold mt-2 text-xs">High-Key</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="black_white">
                            <div class="text-center">
                                <i class="fas fa-adjust mode-icon text-gray-600"></i>
                                <h3 class="font-bold mt-2 text-xs">B&W</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="beauty_closeup">
                            <div class="text-center">
                                <i class="fas fa-spa mode-icon text-pink-400"></i>
                                <h3 class="font-bold mt-2 text-xs">Beauty</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="athletic">
                            <div class="text-center">
                                <i class="fas fa-running mode-icon text-orange-500"></i>
                                <h3 class="font-bold mt-2 text-xs">Athletic</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="creative_color">
                            <div class="text-center">
                                <i class="fas fa-palette mode-icon text-violet-500"></i>
                                <h3 class="font-bold mt-2 text-xs">Creative</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="vintage_retro">
                            <div class="text-center">
                                <i class="fas fa-clock mode-icon text-sepia"></i>
                                <h3 class="font-bold mt-2 text-xs">Vintage</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="minimalist">
                            <div class="text-center">
                                <i class="fas fa-minus mode-icon text-gray-400"></i>
                                <h3 class="font-bold mt-2 text-xs">Minimalist</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="cultural">
                            <div class="text-center">
                                <i class="fas fa-globe mode-icon text-teal-500"></i>
                                <h3 class="font-bold mt-2 text-xs">Cultural</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="conceptual">
                            <div class="text-center">
                                <i class="fas fa-lightbulb mode-icon text-yellow-500"></i>
                                <h3 class="font-bold mt-2 text-xs">Conceptual</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="luxury">
                            <div class="text-center">
                                <i class="fas fa-crown mode-icon text-amber-500"></i>
                                <h3 class="font-bold mt-2 text-xs">Luxury</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="avatar">
                            <div class="text-center">
                                <i class="fas fa-user-astronaut mode-icon text-indigo-500"></i>
                                <h3 class="font-bold mt-2 text-xs">Avatar</h3>
                            </div>
                        </div>

                        <div class="mode-card card bg-base-100 p-3 hover:bg-base-300" data-mode="restoration">
                            <div class="text-center">
                                <i class="fas fa-magic mode-icon text-cyan-500"></i>
                                <h3 class="font-bold mt-2 text-xs">Restore</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Panel: Input -->
            <div class="space-y-6">
                <!-- Upload Section -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body">
                        <h3 class="card-title">
                            <i class="fas fa-upload"></i>
                            Input Image
                        </h3>
                        
                        <div id="uploadZone" class="upload-zone flex items-center justify-center cursor-pointer">
                            <input type="file" id="imageInput" accept="image/*" class="hidden" multiple />
                            <div id="uploadPlaceholder" class="text-center">
                                <i class="fas fa-cloud-upload-alt text-5xl text-base-content/30 mb-4"></i>
                                <p class="text-xl font-medium">Drop images here</p>
                                <p class="text-sm text-base-content/60 mt-2">Or click to browse</p>
                                <p class="text-xs text-base-content/40 mt-1">Supports multiple images for batch processing</p>
                            </div>
                            <div id="imagePreviewContainer" class="hidden w-full">
                                <div id="imagesGrid" class="grid grid-cols-2 gap-2 mb-3">
                                    <!-- Images will be added here dynamically -->
                                </div>
                                <div class="flex gap-2 mt-3">
                                    <button id="changeImageBtn" class="btn btn-sm btn-outline flex-1">
                                        <i class="fas fa-exchange-alt"></i> Change All
                                    </button>
                                    <button id="addMoreBtn" class="btn btn-sm btn-outline flex-1">
                                        <i class="fas fa-plus"></i> Add More
                                    </button>
                                </div>
                                <div class="text-center mt-2">
                                    <span id="imageCount" class="text-sm text-base-content/60"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body">
                        <h3 class="card-title">
                            <i class="fas fa-sliders-h"></i>
                            Controls
                        </h3>

                        <!-- Prompt -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-bold">Prompt</span>
                            </label>
                            <textarea id="promptInput" class="textarea textarea-bordered h-24" 
                                placeholder="Describe what you want to create or modify..."></textarea>
                        </div>

                        <!-- Mode-specific controls -->
                        <div id="modeControls" class="mt-4">
                            <!-- Corporate Headshot Options -->
                            <div id="corporateControls" class="hidden">
                                <label class="label">
                                    <span class="label-text font-bold">Background</span>
                                </label>
                                <select id="backgroundSelect" class="select select-bordered w-full">
                                    <option value="neutral_gray">Neutral Gray</option>
                                    <option value="clean_white">Clean White</option>
                                    <option value="soft_gradient">Soft Gradient</option>
                                    <option value="office_blur">Blurred Office</option>
                                    <option value="outdoor_blur">Blurred Outdoor</option>
                                </select>
                            </div>

                            <!-- Influencer Options -->
                            <div id="influencerControls" class="hidden">
                                <label class="label">
                                    <span class="label-text font-bold">Aesthetic</span>
                                </label>
                                <select id="aestheticSelect" class="select select-bordered w-full">
                                    <option value="glamorous">Glamorous & Luxe</option>
                                    <option value="natural_beauty">Natural Beauty</option>
                                    <option value="golden_hour">Golden Hour Glow</option>
                                    <option value="urban_chic">Urban Chic</option>
                                    <option value="soft_dreamy">Soft & Dreamy</option>
                                    <option value="vibrant_bold">Vibrant & Bold</option>
                                </select>
                            </div>

                            <!-- Dating Profile Options -->
                            <div id="datingControls" class="hidden">
                                <label class="label">
                                    <span class="label-text font-bold">Dating Vibe</span>
                                </label>
                                <select id="datingVibeSelect" class="select select-bordered w-full">
                                    <option value="confident_authentic">Confident & Authentic</option>
                                    <option value="playful_fun">Playful & Fun</option>
                                    <option value="warm_approachable">Warm & Approachable</option>
                                    <option value="adventurous">Adventurous Spirit</option>
                                    <option value="sophisticated">Sophisticated & Classy</option>
                                    <option value="casual_relaxed">Casual & Relaxed</option>
                                </select>
                            </div>

                            <!-- Founder Headshot Options -->
                            <div id="founderControls" class="hidden">
                                <label class="label">
                                    <span class="label-text font-bold">Leadership Vibe</span>
                                </label>
                                <select id="vibeSelect" class="select select-bordered w-full">
                                    <option value="visionary">Visionary Leader</option>
                                    <option value="approachable_ceo">Approachable CEO</option>
                                    <option value="tech_innovator">Tech Innovator</option>
                                    <option value="disruptor">Industry Disruptor</option>
                                    <option value="thought_leader">Thought Leader</option>
                                    <option value="creative_founder">Creative Founder</option>
                                </select>
                            </div>

                            <!-- Avatar Options -->
                            <div id="avatarControls" class="hidden">
                                <label class="label">
                                    <span class="label-text font-bold">Avatar Style</span>
                                </label>
                                <select id="avatarStyleSelect" class="select select-bordered w-full">
                                    <option value="semi_realistic">Semi-Realistic</option>
                                    <option value="3d_pixar">3D Pixar Style</option>
                                    <option value="anime">Anime Character</option>
                                    <option value="comic_book">Comic Book Hero</option>
                                    <option value="digital_art">Digital Art</option>
                                    <option value="fantasy">Fantasy Character</option>
                                </select>
                            </div>
                        </div>

                        <!-- Resolution & Aspect Ratio - Always Visible -->
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-bold">Resolution</span>
                                </label>
                                <select id="resolutionSelect" class="select select-bordered w-full">
                                    <option value="1K" selected>1K (Standard)</option>
                                    <option value="2K">2K (High Quality)</option>
                                    <option value="4K">4K (Ultra HD)</option>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-bold">Aspect Ratio</span>
                                </label>
                                <select id="aspectRatioSelect" class="select select-bordered w-full">
                                    <option value="auto" selected>Auto</option>
                                    <option value="1:1">1:1 (Square)</option>
                                    <option value="4:5">4:5 (Portrait)</option>
                                    <option value="3:4">3:4</option>
                                    <option value="2:3">2:3</option>
                                    <option value="9:16">9:16 (Story)</option>
                                    <option value="16:9">16:9 (Wide)</option>
                                    <option value="3:2">3:2</option>
                                    <option value="4:3">4:3</option>
                                    <option value="21:9">21:9 (Ultra Wide)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="collapse collapse-arrow bg-base-100 mt-4">
                            <input type="checkbox" />
                            <div class="collapse-title text-sm font-medium">
                                Advanced Settings
                            </div>
                            <div class="collapse-content">
                                <div class="advanced-controls">
                                    <div class="control-group">
                                        <label class="text-sm">Output Format</label>
                                        <select id="outputFormatSelect" class="select select-bordered select-sm">
                                            <option value="png" selected>PNG (Lossless)</option>
                                            <option value="jpeg">JPEG (Compressed)</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label class="text-sm">Number of Images</label>
                                        <input type="number" id="numImages" min="1" max="4" value="1" class="input input-bordered input-sm" />
                                    </div>
                                    <div class="control-group">
                                        <label class="text-sm">Seed (Optional)</label>
                                        <input type="number" id="seedInput" class="input input-bordered input-sm" placeholder="Random" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Button -->
                        <div class="mt-6">
                            <button id="generateBtn" class="btn btn-primary w-full nano-gradient">
                                <i class="fas fa-sparkles"></i>
                                Generate Magic
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Timeline -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i>
                            Edit History
                        </h3>
                        <div id="historyTimeline" class="history-timeline max-h-64 overflow-y-auto">
                            <p class="text-base-content/50 text-center py-8">No edits yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="space-y-6">
                <!-- Results Section -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body">
                        <h3 class="card-title">
                            <i class="fas fa-images"></i>
                            Results
                        </h3>
                        
                        <div id="resultsContainer">
                            <div id="noResults" class="text-center py-16">
                                <i class="fas fa-magic text-6xl text-base-content/20 mb-4"></i>
                                <p class="text-xl text-base-content/60">Your creations will appear here</p>
                            </div>
                            
                            <div id="resultsGrid" class="result-grid hidden"></div>
                        </div>

                        <!-- Result Actions -->
                        <div id="resultActions" class="hidden mt-4">
                            <div class="flex gap-2">
                                <button id="downloadAllBtn" class="btn btn-sm btn-outline">
                                    <i class="fas fa-download"></i> Download All
                                </button>
                                <button id="saveToGalleryBtn" class="btn btn-sm btn-outline">
                                    <i class="fas fa-save"></i> Save to Gallery
                                </button>
                                <button id="continueEditingBtn" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i> Continue Editing
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Tips -->
                <div class="card bg-gradient-to-br from-purple-500/10 to-pink-500/10 shadow-xl">
                    <div class="card-body">
                        <h3 class="card-title">
                            <i class="fas fa-lightbulb text-yellow-500"></i>
                            Pro Tips
                        </h3>
                        <div id="modeTips" class="text-sm space-y-2">
                            <p class="flex items-start">
                                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                                <span>Select a mode above to see specific tips and features</span>
                            </p>
                            <p class="flex items-start">
                                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                                <span>Upload multiple images for batch processing</span>
                            </p>
                            <p class="flex items-start">
                                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                                <span>Chain edits together to create complex transformations</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="nano-text-gradient text-2xl font-bold mb-4">Processing with Nano Banana Pro</div>
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-sm text-gray-600 mt-2">Initializing...</p>
        <p class="text-xs text-gray-500 mt-2">⏱️ This may take 30-60 seconds or more depending on complexity</p>
        <div class="loading loading-spinner loading-lg mt-4"></div>
    </div>
</div>

<script>
// Nano Studio Main Application
class NanoStudio {
    constructor() {
        this.currentMode = 'studio_portrait';
        this.uploadedImages = [];
        this.editHistory = [];
        this.results = [];
        this.isProcessing = false;
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadHistory();
    }

    setupEventListeners() {
        // Mode selection
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', (e) => this.selectMode(e.currentTarget.dataset.mode));
        });

        // Upload handling
        const uploadZone = document.getElementById('uploadZone');
        const imageInput = document.getElementById('imageInput');
        
        uploadZone.addEventListener('click', (e) => {
            // Prevent event from triggering on child elements
            if (e.target === uploadZone || e.target.id === 'uploadPlaceholder' || e.target.closest('#uploadPlaceholder')) {
                imageInput.click();
            }
        });
        uploadZone.addEventListener('dragover', this.handleDragOver.bind(this));
        uploadZone.addEventListener('dragleave', this.handleDragLeave.bind(this));
        uploadZone.addEventListener('drop', this.handleDrop.bind(this));
        imageInput.addEventListener('change', this.handleFileSelect.bind(this));

        // Buttons - Fixed to properly handle input reset
        document.getElementById('changeImageBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            this.uploadedImages = [];
            this.updateImagePreview();
            // Small delay to ensure DOM updates before clicking
            setTimeout(() => {
                imageInput.value = '';
                imageInput.click();
            }, 100);
        });
        document.getElementById('addMoreBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            imageInput.click();
        });
        document.getElementById('generateBtn').addEventListener('click', () => this.generate());
        document.getElementById('downloadAllBtn')?.addEventListener('click', () => this.downloadAll());
        document.getElementById('saveToGalleryBtn')?.addEventListener('click', () => this.saveToGallery());
        document.getElementById('continueEditingBtn')?.addEventListener('click', () => this.continueEditing());

        // Style options
        document.querySelectorAll('.style-option').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.style-option').forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
            });
        });

        // Sliders
        const tempSlider = document.getElementById('temperatureSlider');
        tempSlider?.addEventListener('input', (e) => {
            document.getElementById('temperatureValue').textContent = e.target.value;
        });
    }

    selectMode(mode) {
        this.currentMode = mode;

        // Update UI
        document.querySelectorAll('.mode-card').forEach(card => {
            card.classList.remove('active');
            if (card.dataset.mode === mode) {
                card.classList.add('active');
            }
        });

        // Show mode-specific controls
        this.showModeControls(mode);

        // Update mode description
        this.updateModeDescription(mode);

        // Update tips
        this.updateTips(mode);
    }

    updateModeDescription(mode) {
        const descriptions = {
            studio_portrait: {
                icon: 'fas fa-camera',
                color: 'text-purple-500',
                title: 'Studio Portrait',
                text: 'Professional studio photography with clean seamless background, soft three-point lighting setup, and polished refined look. Perfect for portfolios, headshots, and professional branding. Your facial features are preserved with 100% accuracy.'
            },
            cinematic: {
                icon: 'fas fa-film',
                color: 'text-amber-500',
                title: 'Cinematic Portrait',
                text: 'Movie-scene quality with dramatic lighting, shallow depth of field, and atmospheric mood. Includes film-like color grading (teal & orange, etc.), bokeh effects, and narrative composition. Perfect for creative portfolios and artistic expression.'
            },
            corporate_headshot: {
                icon: 'fas fa-user-tie',
                color: 'text-blue-500',
                title: 'Corporate Headshot',
                text: 'LinkedIn-ready professional headshot with clean background, flattering business lighting, and confident approachable expression. Ideal for job applications, company websites, and professional networking. Executive presence guaranteed.'
            },
            fashion_editorial: {
                icon: 'fas fa-gem',
                color: 'text-pink-500',
                title: 'Fashion Editorial',
                text: 'High-fashion magazine quality with dramatic intentional lighting, bold editorial poses, and Vogue-worthy styling. Perfect for modeling portfolios, fashion campaigns, and artistic photography.'
            },
            dating: {
                icon: 'fas fa-heart',
                color: 'text-rose-500',
                title: 'Dating Profile Photos',
                text: 'Look your best on Tinder, Bumble, and Hinge. Authentic, attractive photos with warm lighting, genuine expressions, and approachable vibes. Stand out and get more matches with photos that show the real you.'
            },
            influencer: {
                icon: 'fab fa-instagram',
                color: 'text-pink-500',
                title: 'Social Media Influencer',
                text: 'Instagram-ready photos with trendy aesthetics, flattering lighting, and scroll-stopping appeal. Choose from glamorous, natural, golden hour, urban chic, or soft dreamy styles. Optimized for engagement.'
            },
            founder_headshot: {
                icon: 'fas fa-rocket',
                color: 'text-emerald-500',
                title: 'Startup Founder',
                text: 'Pitch-deck ready headshots conveying visionary leadership and innovation. Modern tech aesthetic perfect for investor meetings, company about pages, and press features. Project confidence and authority.'
            },
            environmental: {
                icon: 'fas fa-tree',
                color: 'text-green-500',
                title: 'Environmental Portrait',
                text: 'Contextual portraits in meaningful real-world settings that tell your story. Natural lighting with background elements that reveal personality, profession, or interests.'
            },
            lifestyle: {
                icon: 'fas fa-coffee',
                color: 'text-amber-600',
                title: 'Lifestyle Portrait',
                text: 'Authentic, candid-feeling photos capturing natural everyday moments. Warm, inviting atmosphere with relaxed expressions. Perfect for personal branding and social media.'
            },
            street_portrait: {
                icon: 'fas fa-city',
                color: 'text-slate-500',
                title: 'Street Portrait',
                text: 'Urban photography with authentic city backdrops, raw energy, and genuine character. Textured walls, graffiti, and street scenes add context and edge.'
            },
            low_key: {
                icon: 'fas fa-moon',
                color: 'text-gray-700',
                title: 'Low-Key Dramatic',
                text: 'Dramatic portraits dominated by shadows and darkness. Strong single-source lighting sculpts features with high contrast. Mysterious, powerful, and artistic.'
            },
            high_key: {
                icon: 'fas fa-sun',
                color: 'text-yellow-400',
                title: 'High-Key Bright',
                text: 'Bright, airy portraits with minimal shadows. Clean white backgrounds, soft wrap-around lighting, and fresh optimistic mood. Perfect for beauty and wellness.'
            },
            black_white: {
                icon: 'fas fa-adjust',
                color: 'text-gray-600',
                title: 'Black & White',
                text: 'Timeless monochrome portraits with rich tonal range, emotional depth, and classic appeal. Focus on texture, form, and expression without color distraction.'
            },
            beauty_closeup: {
                icon: 'fas fa-spa',
                color: 'text-pink-400',
                title: 'Beauty Close-Up',
                text: 'Professional beauty photography emphasizing flawless skin, makeup details, and facial features. Tight framing with butterfly lighting for glamorous results.'
            },
            athletic: {
                icon: 'fas fa-running',
                color: 'text-orange-500',
                title: 'Athletic Portrait',
                text: 'Dynamic sports photography showcasing strength, power, and physical capability. Dramatic lighting sculpts physique with intense, determined energy.'
            },
            creative_color: {
                icon: 'fas fa-palette',
                color: 'text-violet-500',
                title: 'Creative Color',
                text: 'Bold artistic portraits with neon gels, colored lighting, and vibrant color grading. Contemporary, edgy aesthetic perfect for music, fashion, and creative industries.'
            },
            vintage_retro: {
                icon: 'fas fa-clock',
                color: 'text-amber-700',
                title: 'Vintage Retro',
                text: 'Nostalgic film photography aesthetics - 70s warmth, 80s bold colors, Polaroid feel, or classic Kodachrome. Authentic grain and period-appropriate color science.'
            },
            minimalist: {
                icon: 'fas fa-minus',
                color: 'text-gray-400',
                title: 'Minimalist',
                text: 'Maximum impact through simplicity. Generous negative space, clean backgrounds, and refined elegance. Calm, contemplative, and sophisticated.'
            },
            cultural: {
                icon: 'fas fa-globe',
                color: 'text-teal-500',
                title: 'Cultural Portrait',
                text: 'Celebrating heritage with traditional attire, ethnic styling, and respectful representation. Honors cultural identity with dignified, authentic presentation.'
            },
            conceptual: {
                icon: 'fas fa-lightbulb',
                color: 'text-yellow-500',
                title: 'Conceptual Art',
                text: 'Artistic portraits with symbolic elements, surreal touches, and visual storytelling. Fine art sensibility for creative expression beyond documentation.'
            },
            luxury: {
                icon: 'fas fa-crown',
                color: 'text-amber-500',
                title: 'Luxury Elite',
                text: 'Premium portraits exuding wealth, power, and sophistication. Rich lighting, high-end fashion aesthetic, and refined elegance. Aspirational quality.'
            },
            avatar: {
                icon: 'fas fa-user-astronaut',
                color: 'text-indigo-500',
                title: 'Stylized Avatar',
                text: 'Artistic character transformation while maintaining your likeness. Choose semi-realistic, 3D Pixar, anime, comic book, or fantasy styles for profile pictures and gaming.'
            },
            restoration: {
                icon: 'fas fa-magic',
                color: 'text-cyan-500',
                title: 'Photo Restoration',
                text: 'Enhance and restore image quality. Fix imperfections, improve sharpness, correct colors, and elevate overall quality while maintaining authenticity.'
            }
        };

        const desc = descriptions[mode] || descriptions.studio_portrait;
        document.getElementById('modeDescIcon').className = `${desc.icon} text-2xl ${desc.color}`;
        document.getElementById('modeDescTitle').textContent = desc.title;
        document.getElementById('modeDescText').textContent = desc.text;
    }

    showModeControls(mode) {
        // Hide all mode controls
        document.querySelectorAll('[id$="Controls"]').forEach(el => el.classList.add('hidden'));

        // Show specific controls based on mode
        switch(mode) {
            case 'corporate_headshot':
                document.getElementById('corporateControls')?.classList.remove('hidden');
                break;
            case 'influencer':
                document.getElementById('influencerControls')?.classList.remove('hidden');
                break;
            case 'dating':
                document.getElementById('datingControls')?.classList.remove('hidden');
                break;
            case 'founder_headshot':
                document.getElementById('founderControls')?.classList.remove('hidden');
                break;
            case 'avatar':
                document.getElementById('avatarControls')?.classList.remove('hidden');
                break;
        }
    }

    updateTips(mode) {
        const tipsContainer = document.getElementById('modeTips');
        const tips = {
            studio_portrait: [
                'Clean background with soft, diffused lighting',
                'Perfect for professional portfolios',
                'Polished and refined look'
            ],
            cinematic: [
                'Movie-scene lighting with shallow depth of field',
                'Moody atmospheric tones',
                'Dramatic composition'
            ],
            corporate_headshot: [
                'LinkedIn-ready professional headshots',
                'Clean corporate appearance',
                'Stand out to recruiters'
            ],
            fashion_editorial: [
                'High-fashion magazine styling',
                'Dramatic lighting and bold poses',
                'Editorial quality results'
            ],
            dating: [
                'Optimized for Tinder, Bumble, Hinge',
                'Authentic yet attractive photos',
                'Get more matches with genuine appeal'
            ],
            influencer: [
                'Instagram-ready social media shots',
                'Trendy poses with lifestyle framing',
                'Boost your social presence'
            ],
            founder_headshot: [
                'Perfect for pitch decks & investor meetings',
                'Visionary leadership presence',
                'Modern tech aesthetic'
            ],
            environmental: ['Person in meaningful real-world setting', 'Natural lighting'],
            lifestyle: ['Candid everyday moments', 'Relaxed and authentic'],
            street_portrait: ['Urban backgrounds', 'Raw authentic energy'],
            low_key: ['Dark dramatic contrast', 'Deep shadows'],
            high_key: ['Bright airy mood', 'Clean whites'],
            black_white: ['Timeless emotional portraits', 'Rich tonal range'],
            beauty_closeup: ['Skin detail emphasis', 'Perfect symmetry'],
            athletic: ['Power stance and motion', 'Dynamic energy'],
            creative_color: ['Bold neon lighting', 'Artistic color grading'],
            vintage_retro: ['Film grain aesthetics', 'Nostalgic tones'],
            minimalist: ['Simple elegant pose', 'Generous negative space'],
            cultural: ['Heritage styling', 'Traditional elements'],
            conceptual: ['Symbolic surreal elements', 'Visual storytelling'],
            luxury: ['Premium fashion styling', 'Rich sophisticated lighting'],
            avatar: ['Stylized character transformation', 'Artistic rendering'],
            restoration: ['Fix and enhance old photos', 'Improve quality']
        };

        const modeTips = tips[mode] || ['Upload an image and add a prompt to get started'];
        tipsContainer.innerHTML = modeTips.map(tip => `
            <p class="flex items-start">
                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                <span>${tip}</span>
            </p>
        `).join('');
    }

    handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('dragover');
    }

    handleDragLeave(e) {
        e.currentTarget.classList.remove('dragover');
    }

    handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        this.processFiles(files);
    }

    handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            this.processFiles(files);
        }
    }

    async processFiles(files) {
        // Process all files and then update preview once
        const promises = [];
        
        for (const file of files) {
            if (file.type.startsWith('image/')) {
                promises.push(this.processAndCompressImage(file));
            }
        }
        
        // Wait for all files to be processed
        await Promise.all(promises);
        // Update preview once after all files are loaded
        this.updateImagePreview();
    }

    async processAndCompressImage(file) {
        // Check if the file is large (iPhone images are typically > 2MB)
        const MAX_SIZE_MB = 2;
        const fileSizeMB = file.size / (1024 * 1024);
        
        console.log(`Processing image: ${file.name}, Size: ${fileSizeMB.toFixed(2)}MB`);
        
        if (fileSizeMB > MAX_SIZE_MB) {
            // Compress large images
            try {
                const compressedDataUrl = await this.compressImage(file);
                this.uploadedImages.push({
                    url: compressedDataUrl,
                    file: file,
                    name: file.name,
                    wasCompressed: true,
                    originalSize: fileSizeMB,
                    compressedSize: compressedDataUrl.length / (1024 * 1024)
                });
                console.log(`Image compressed: ${fileSizeMB.toFixed(2)}MB -> ${(compressedDataUrl.length / (1024 * 1024)).toFixed(2)}MB`);
            } catch (error) {
                console.error('Compression failed, using original:', error);
                // Fallback to original if compression fails
                return this.readFileAsDataUrl(file);
            }
        } else {
            // Use original for smaller files
            return this.readFileAsDataUrl(file);
        }
    }

    readFileAsDataUrl(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                this.uploadedImages.push({
                    url: e.target.result,
                    file: file,
                    name: file.name,
                    wasCompressed: false
                });
                resolve();
            };
            reader.onerror = () => resolve();
            reader.readAsDataURL(file);
        });
    }

    compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const img = new Image();
                
                img.onload = () => {
                    // Create canvas for compression
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate new dimensions (max 1536x1536 for FAL)
                    const MAX_WIDTH = 1536;
                    const MAX_HEIGHT = 1536;
                    let width = img.width;
                    let height = img.height;
                    
                    // Resize if needed
                    if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                        const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }
                    
                    // Set canvas dimensions
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Apply EXIF orientation if needed (for iPhone images)
                    this.handleImageOrientation(img, canvas, ctx, width, height);
                    
                    // Convert to JPEG with quality compression
                    // Start with 0.85 quality and reduce if still too large
                    let quality = 0.85;
                    let dataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    // Further compress if still too large
                    while (dataUrl.length > 2 * 1024 * 1024 && quality > 0.5) {
                        quality -= 0.05;
                        dataUrl = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    resolve(dataUrl);
                };
                
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = e.target.result;
            };
            
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(file);
        });
    }

    handleImageOrientation(img, canvas, ctx, width, height) {
        // This handles common iPhone orientation issues
        // In a production environment, you'd want to read EXIF data
        // For now, we'll just draw normally and let the server handle orientation
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, width, height);
        ctx.drawImage(img, 0, 0, width, height);
    }

    removeImage(index) {
        this.uploadedImages.splice(index, 1);
        this.updateImagePreview();
    }

    updateImagePreview() {
        if (this.uploadedImages.length > 0) {
            const imagesGrid = document.getElementById('imagesGrid');
            const container = document.getElementById('imagePreviewContainer');
            const placeholder = document.getElementById('uploadPlaceholder');
            const imageCount = document.getElementById('imageCount');
            
            // Clear existing previews
            imagesGrid.innerHTML = '';
            
            // Display all uploaded images
            this.uploadedImages.forEach((img, index) => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'relative group';
                
                // Add compression indicator if image was compressed
                const compressionBadge = img.wasCompressed ? 
                    `<div class="absolute top-2 left-2 badge badge-success badge-sm">
                        <i class="fas fa-compress mr-1"></i>
                        ${img.originalSize.toFixed(1)}MB → ${img.compressedSize.toFixed(1)}MB
                    </div>` : '';
                
                imageDiv.innerHTML = `
                    <div class="image-preview-container relative">
                        <img src="${img.url}" class="image-preview rounded" style="max-height: 200px;" />
                        ${compressionBadge}
                        <button onclick="nanoStudio.removeImage(${index})" 
                                class="absolute top-2 right-2 btn btn-circle btn-sm btn-error opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-xs text-center mt-1 truncate">${img.name || `Image ${index + 1}`}</p>
                `;
                imagesGrid.appendChild(imageDiv);
            });
            
            container.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            // Update image count text
            imageCount.textContent = `${this.uploadedImages.length} image${this.uploadedImages.length > 1 ? 's' : ''} uploaded`;
            
            // Adjust grid columns based on number of images
            if (this.uploadedImages.length === 1) {
                imagesGrid.className = 'grid grid-cols-1 gap-2 mb-3';
            } else if (this.uploadedImages.length === 2) {
                imagesGrid.className = 'grid grid-cols-2 gap-2 mb-3';
            } else {
                imagesGrid.className = 'grid grid-cols-2 md:grid-cols-3 gap-2 mb-3';
            }
        } else {
            // Show placeholder if no images
            const container = document.getElementById('imagePreviewContainer');
            const placeholder = document.getElementById('uploadPlaceholder');
            container.classList.add('hidden');
            placeholder.classList.remove('hidden');
        }
    }

    async generate() {
        if (this.isProcessing) return;
        
        const prompt = document.getElementById('promptInput').value;
        if (!prompt && this.currentMode !== 'restoration') {
            alert('Please enter a prompt');
            return;
        }

        // Show time warning notification
        const notification = document.createElement('div');
        notification.className = 'toast toast-top toast-center z-50';
        notification.innerHTML = `
            <div class="alert alert-info shadow-lg">
                <i class="fas fa-info-circle"></i>
                <span>Generation typically takes 30-60 seconds. Please wait...</span>
            </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);

        this.showLoading(true);
        this.isProcessing = true;

        try {
            const requestData = {
                mode: this.currentMode,
                prompt: prompt,
                num_images: parseInt(document.getElementById('numImages')?.value || 1)
            };

            // Add uploaded images
            if (this.uploadedImages.length > 0) {
                requestData.image_urls = this.uploadedImages.map(img => img.url);
            }

            // Add mode-specific parameters
            this.addModeParameters(requestData);

            // Add advanced settings (with null checks)
            const tempSlider = document.getElementById('temperatureSlider');
            if (tempSlider) requestData.temperature = parseFloat(tempSlider.value);

            const seedInput = document.getElementById('seedInput');
            if (seedInput && seedInput.value) requestData.seed = parseInt(seedInput.value);

            // Add Nano Banana Pro specific parameters
            const resSelect = document.getElementById('resolutionSelect');
            const aspectSelect = document.getElementById('aspectRatioSelect');
            const formatSelect = document.getElementById('outputFormatSelect');

            if (resSelect) requestData.resolution = resSelect.value;
            if (aspectSelect) requestData.aspect_ratio = aspectSelect.value;
            if (formatSelect) requestData.output_format = formatSelect.value;

            const response = await fetch('/api/magix/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrf_token
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Generation failed');
            }

            this.handleResults(result);
            this.addToHistory(result);

        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        } finally {
            this.showLoading(false);
            this.isProcessing = false;
        }
    }

    addModeParameters(data) {
        switch(this.currentMode) {
            case 'corporate_headshot':
                const bgSelect = document.getElementById('backgroundSelect');
                if (bgSelect) data.background = bgSelect.value;
                break;
            case 'influencer':
                const aestheticSelect = document.getElementById('aestheticSelect');
                if (aestheticSelect) data.aesthetic = aestheticSelect.value;
                break;
            case 'dating':
                const datingVibeSelect = document.getElementById('datingVibeSelect');
                if (datingVibeSelect) data.dating_vibe = datingVibeSelect.value;
                break;
            case 'founder_headshot':
                const vibeSelect = document.getElementById('vibeSelect');
                if (vibeSelect) data.vibe = vibeSelect.value;
                break;
            case 'avatar':
                const avatarSelect = document.getElementById('avatarStyleSelect');
                if (avatarSelect) data.style = avatarSelect.value;
                break;
        }
    }

    handleResults(result) {
        const resultsGrid = document.getElementById('resultsGrid');
        const noResults = document.getElementById('noResults');
        const resultActions = document.getElementById('resultActions');
        
        // Clear previous results
        resultsGrid.innerHTML = '';
        
        // Add new results
        if (result.images && result.images.length > 0) {
            result.images.forEach((img, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item slide-in shadow-xl';
                resultItem.innerHTML = `
                    <div class="relative">
                        <img src="${img.url}" alt="Result ${index + 1}" class="w-full" />
                        <div class="absolute top-0 left-0 right-0 p-3 bg-gradient-to-b from-black/60 to-transparent">
                            <span class="text-white text-sm font-medium">Result ${index + 1}</span>
                            ${img.width && img.height ? `<span class="text-white text-xs ml-2">${img.width}x${img.height}</span>` : ''}
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent flex justify-center gap-3">
                            <button class="btn btn-sm btn-circle btn-ghost text-white hover:bg-white/20" onclick="nanoStudio.downloadImage('${img.url}')" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-circle btn-ghost text-white hover:bg-white/20" onclick="nanoStudio.useAsInput('${img.url}')" title="Use as Input">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="btn btn-sm btn-circle btn-ghost text-white hover:bg-white/20" onclick="nanoStudio.viewFullscreen('${img.url}')" title="View Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="btn btn-sm btn-circle btn-ghost text-white hover:bg-white/20" onclick="nanoStudio.copyToClipboard('${img.url}')" title="Copy Image URL">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                `;
                resultsGrid.appendChild(resultItem);
            });
            
            this.results = result.images;
            resultsGrid.classList.remove('hidden');
            noResults.classList.add('hidden');
            resultActions.classList.remove('hidden');
        }
    }

    addToHistory(result) {
        const historyTimeline = document.getElementById('historyTimeline');
        
        // Create timeline item
        const timelineItem = document.createElement('div');
        timelineItem.className = 'timeline-item slide-in';
        
        const time = new Date().toLocaleTimeString();
        const mode = this.currentMode;
        const prompt = document.getElementById('promptInput').value;
        
        timelineItem.innerHTML = `
            <div class="bg-base-100 rounded-lg p-3">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-sm font-bold">${mode.charAt(0).toUpperCase() + mode.slice(1)}</span>
                    <span class="text-xs text-base-content/60">${time}</span>
                </div>
                <p class="text-sm text-base-content/80">${prompt || 'No prompt'}</p>
                ${result.images ? `
                    <div class="flex gap-1 mt-2">
                        ${result.images.slice(0, 3).map(img => `
                            <img src="${img.url}" class="w-16 h-16 object-cover rounded" />
                        `).join('')}
                        ${result.images.length > 3 ? `<span class="text-xs self-center">+${result.images.length - 3}</span>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
        
        // Remove placeholder if exists
        const placeholder = historyTimeline.querySelector('p');
        if (placeholder) placeholder.remove();
        
        // Add to beginning of timeline
        historyTimeline.insertBefore(timelineItem, historyTimeline.firstChild);
        
        // Keep only last 10 items
        while (historyTimeline.children.length > 10) {
            historyTimeline.removeChild(historyTimeline.lastChild);
        }
        
        // Save to local storage
        this.editHistory.unshift(result);
        this.saveHistory();
    }


    copyToClipboard(url) {
        navigator.clipboard.writeText(url).then(() => {
            alert('Image URL copied to clipboard!');
        }).catch(() => {
            alert('Failed to copy URL');
        });
    }

    downloadImage(url) {
        const link = document.createElement('a');
        link.href = url;
        link.download = `nano_studio_${Date.now()}.jpg`;
        link.click();
    }

    downloadAll() {
        this.results.forEach((img, index) => {
            setTimeout(() => this.downloadImage(img.url), index * 500);
        });
    }

    async useAsInput(url) {
        // If it's a local URL, convert to base64
        if (url.startsWith('/static/') || !url.startsWith('data:')) {
            try {
                // Fetch the image and convert to base64
                const response = await fetch(url);
                const blob = await response.blob();
                const reader = new FileReader();
                
                reader.onload = () => {
                    this.uploadedImages = [{
                        url: reader.result,
                        name: 'Generated Image',
                        wasCompressed: false
                    }];
                    this.updateImagePreview();
                    window.scrollTo({top: 0, behavior: 'smooth'});
                };
                
                reader.readAsDataURL(blob);
            } catch (error) {
                console.error('Error converting image to base64:', error);
                alert('Failed to load image as input. Please try again.');
            }
        } else {
            // Already a data URL, use directly
            this.uploadedImages = [{
                url: url,
                name: 'Generated Image',
                wasCompressed: false
            }];
            this.updateImagePreview();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    }

    viewFullscreen(url) {
        window.open(url, '_blank');
    }

    async saveToGallery() {
        // Already saved automatically in backend
        alert('Images saved to gallery!');
    }

    async continueEditing() {
        if (this.results.length > 0) {
            // Convert all result images to base64 before using as input
            this.uploadedImages = [];
            
            for (const result of this.results) {
                if (result.url.startsWith('/static/') || !result.url.startsWith('data:')) {
                    try {
                        const response = await fetch(result.url);
                        const blob = await response.blob();
                        const reader = new FileReader();
                        
                        await new Promise((resolve) => {
                            reader.onload = () => {
                                this.uploadedImages.push({
                                    url: reader.result,
                                    name: 'Generated Image',
                                    wasCompressed: false
                                });
                                resolve();
                            };
                            reader.readAsDataURL(blob);
                        });
                    } catch (error) {
                        console.error('Error converting image:', error);
                    }
                } else {
                    this.uploadedImages.push({
                        url: result.url,
                        name: 'Generated Image',
                        wasCompressed: false
                    });
                }
            }
            
            this.updateImagePreview();
            document.getElementById('promptInput').value = '';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    }

    showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.add('active');
            this.animateProgress();
        } else {
            overlay.classList.remove('active');
        }
    }

    animateProgress() {
        const fill = document.getElementById('progressFill');
        const text = document.getElementById('progressText');
        
        const messages = [
            'Initializing Nano Banana Pro... (30-60 seconds expected)',
            'Understanding your request... Please be patient',
            'Processing with advanced AI models...',
            'Applying transformations... Almost there',
            'Finalizing your masterpiece...'
        ];
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            fill.style.width = progress + '%';
            text.textContent = messages[Math.floor(progress / 20)] || messages[0];
            
            if (!this.isProcessing) {
                fill.style.width = '100%';
                text.textContent = 'Complete!';
                clearInterval(interval);
            }
        }, 500);
    }

    loadHistory() {
        const saved = localStorage.getItem('nanoStudioHistory');
        if (saved) {
            this.editHistory = JSON.parse(saved);
        }
    }

    saveHistory() {
        localStorage.setItem('nanoStudioHistory', JSON.stringify(this.editHistory.slice(0, 50)));
    }
}

// Initialize application
const nanoStudio = new NanoStudio();

// Set page title
document.title = 'Magix Nano Studio';
</script>
{% endblock %}